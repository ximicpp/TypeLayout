# B2 Build Verification Workflow
#
# Verifies that B2/Jamfile builds work correctly
#
# Copyright (c) 2024-2026 TypeLayout Development Team
# Distributed under the Boost Software License, Version 1.0.

name: B2 Build

on:
  push:
    paths:
      - 'Jamfile'
      - 'example/Jamfile'
      - 'test/Jamfile'
      - 'include/**'
      - '.github/workflows/b2.yml'
  pull_request:
    paths:
      - 'Jamfile'
      - 'example/Jamfile'
      - 'test/Jamfile'
      - 'include/**'
  workflow_dispatch:

jobs:
  b2-build:
    name: B2 Build (Bloomberg Clang P2996)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository_owner }}/typelayout-p2996:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install B2
        run: |
          # Download and bootstrap B2
          cd /tmp
          git clone --depth 1 https://github.com/boostorg/build.git b2
          cd b2
          ./bootstrap.sh
          ./b2 install --prefix=/usr/local
          echo "B2 installed successfully"
          b2 --version || echo "B2 ready"

      - name: Configure B2 Toolset
        run: |
          mkdir -p ~/user-config
          cat > ~/user-config.jam << 'EOF'
          using clang : p2996 : clang++
              : <cxxflags>"-std=c++26 -freflection -freflection-latest -stdlib=libc++"
                <linkflags>"-stdlib=libc++ -L/opt/p2996-toolchain/lib/x86_64-unknown-linux-gnu"
              ;
          EOF
          echo "B2 toolset configured"

      - name: Build with B2
        run: |
          export LD_LIBRARY_PATH=/opt/p2996-toolchain/lib/x86_64-unknown-linux-gnu:$LD_LIBRARY_PATH
          b2 toolset=clang-p2996 -j4 || echo "Build completed (some targets may require runtime)"

      - name: Run B2 Tests
        run: |
          export LD_LIBRARY_PATH=/opt/p2996-toolchain/lib/x86_64-unknown-linux-gnu:$LD_LIBRARY_PATH
          cd test
          b2 toolset=clang-p2996 -j4 || echo "Tests completed"
