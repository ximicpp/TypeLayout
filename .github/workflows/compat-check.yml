# Boost.TypeLayout
#
# Cross-Platform Compatibility Check - Reusable Workflow
#
# Two-phase pipeline:
#   Phase 1: Export type signatures on each target platform (requires P2996 Clang)
#   Phase 2: Compare .sig.hpp headers at compile time (any C++17 compiler)
#
# The user provides two .cpp source files:
#   - export_source: uses TYPELAYOUT_EXPORT_TYPES(...) macro  → Phase 1
#   - check_source:  uses TYPELAYOUT_CHECK_COMPAT(...)        → Phase 2
#
# Usage in your repository:
#   jobs:
#     compat-check:
#       uses: aspect-labs/typelayout/.github/workflows/compat-check.yml@v1
#       with:
#         export_source: 'src/export_types.cpp'
#         check_source:  'src/check_compat.cpp'
#         platforms: 'x86_64-linux-clang,arm64-linux-clang'
#
# Copyright (c) 2024-2026 TypeLayout Development Team
# Distributed under the Boost Software License, Version 1.0.

name: Cross-Platform Type Compatibility Check

on:
  workflow_call:
    inputs:
      export_source:
        description: >
          Path to C++ source file using TYPELAYOUT_EXPORT_TYPES(...) macro.
          This file is compiled with P2996 Clang on each target platform.
        required: true
        type: string
      check_source:
        description: >
          Path to C++ source file using TYPELAYOUT_CHECK_COMPAT(...) or
          TYPELAYOUT_ASSERT_COMPAT(...) macro.
          This file is compiled with a standard C++17 compiler in Phase 2.
        required: true
        type: string
      include_dirs:
        description: >
          Comma-separated list of additional include directories
          (relative to repository root) for user type headers.
        required: false
        default: ''
        type: string
      platforms:
        description: 'Comma-separated list of target platforms (see tools/platforms.conf)'
        required: false
        default: 'x86_64-linux-clang,arm64-linux-clang'
        type: string
      typelayout_ref:
        description: 'TypeLayout repository reference (branch/tag/sha)'
        required: false
        default: 'main'
        type: string

jobs:
  # =====================================================================
  # Parse platform list into a matrix
  # =====================================================================
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.parse.outputs.matrix }}
    steps:
      - name: Parse platform matrix
        id: parse
        run: |
          platforms="${{ inputs.platforms }}"

          # Build JSON matrix from comma-separated platform list
          matrix='{"include":['
          first=true

          IFS=',' read -ra PLATFORMS <<< "$platforms"
          for platform in "${PLATFORMS[@]}"; do
            platform=$(echo "$platform" | xargs)  # trim whitespace

            if [ "$first" = true ]; then
              first=false
            else
              matrix+=','
            fi

            matrix+="{\"platform\":\"$platform\"}"
          done

          matrix+=']}'
          echo "matrix=$matrix" >> $GITHUB_OUTPUT
          echo "Generated matrix: $matrix"

  # =====================================================================
  # Phase 1: Export signatures on each platform (requires P2996 Clang)
  # =====================================================================
  export-signatures:
    needs: setup
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout user repository
        uses: actions/checkout@v4

      - name: Checkout TypeLayout
        uses: actions/checkout@v4
        with:
          repository: aspect-labs/typelayout
          ref: ${{ inputs.typelayout_ref }}
          path: _typelayout

      - name: Read platform config
        id: config
        run: |
          CONF="_typelayout/tools/platforms.conf"
          PLATFORM="${{ matrix.platform }}"

          # Extract fields from INI-style platforms.conf
          get_field() {
            local platform="$1" field="$2" in_section=false
            while IFS= read -r line; do
              [[ "$line" =~ ^[[:space:]]*# ]] && continue
              [[ -z "${line// /}" ]] && continue
              if [[ "$line" =~ ^\[([^\]]+)\] ]]; then
                [[ "${BASH_REMATCH[1]}" == "$platform" ]] && in_section=true || { $in_section && break; }
                continue
              fi
              if $in_section && [[ "$line" =~ ^[[:space:]]*${field}[[:space:]]*=[[:space:]]*(.*) ]]; then
                echo "${BASH_REMATCH[1]}" | sed 's/[[:space:]]*$//'
                return 0
              fi
            done < "$CONF"
            return 1
          }

          IMAGE=$(get_field "$PLATFORM" "docker_image" || echo "")
          COMPILER=$(get_field "$PLATFORM" "compiler" || echo "clang++")
          FLAGS=$(get_field "$PLATFORM" "flags" || echo "")
          LINK_FLAGS=$(get_field "$PLATFORM" "link_flags" || echo "")

          echo "docker_image=$IMAGE" >> $GITHUB_OUTPUT
          echo "compiler=$COMPILER" >> $GITHUB_OUTPUT
          echo "flags=$FLAGS" >> $GITHUB_OUTPUT
          echo "link_flags=$LINK_FLAGS" >> $GITHUB_OUTPUT

      - name: Build include flags
        id: includes
        run: |
          # Build -I flags from comma-separated include_dirs input
          INCLUDE_FLAGS=""
          if [ -n "${{ inputs.include_dirs }}" ]; then
            IFS=',' read -ra DIRS <<< "${{ inputs.include_dirs }}"
            for dir in "${DIRS[@]}"; do
              dir=$(echo "$dir" | xargs)  # trim whitespace
              [ -n "$dir" ] && INCLUDE_FLAGS+=" -I/user_src/$dir"
            done
          fi
          echo "flags=$INCLUDE_FLAGS" >> $GITHUB_OUTPUT

      - name: Export signatures via Docker
        if: steps.config.outputs.docker_image != ''
        run: |
          EXPORT_SRC="${{ inputs.export_source }}"
          SRC_DIR=$(cd "$(dirname "$EXPORT_SRC")" && pwd)
          SRC_FILE=$(basename "$EXPORT_SRC")

          docker run --rm \
            -v "${{ github.workspace }}/_typelayout:/typelayout:ro" \
            -v "${{ github.workspace }}:/user_src:ro" \
            -v "${{ github.workspace }}/_build:/build" \
            -w /tmp/work \
            "${{ steps.config.outputs.docker_image }}" \
            bash -c "
              ${{ steps.config.outputs.compiler }} \
                ${{ steps.config.outputs.flags }} \
                -I/typelayout/include \
                -I/user_src \
                ${{ steps.includes.outputs.flags }} \
                ${{ steps.config.outputs.link_flags }} \
                -o sig_export /user_src/$EXPORT_SRC && \
              ./sig_export /build/
            "

      - name: Export signatures locally (fallback)
        if: steps.config.outputs.docker_image == ''
        run: |
          EXPORT_SRC="${{ inputs.export_source }}"

          # Build local include flags
          INCLUDE_FLAGS=""
          if [ -n "${{ inputs.include_dirs }}" ]; then
            IFS=',' read -ra DIRS <<< "${{ inputs.include_dirs }}"
            for dir in "${DIRS[@]}"; do
              dir=$(echo "$dir" | xargs)
              [ -n "$dir" ] && INCLUDE_FLAGS+=" -I $dir"
            done
          fi

          mkdir -p _build

          ${{ steps.config.outputs.compiler }} \
            ${{ steps.config.outputs.flags }} \
            -I _typelayout/include \
            -I . \
            $INCLUDE_FLAGS \
            ${{ steps.config.outputs.link_flags }} \
            -o _build/sig_export \
            "$EXPORT_SRC"

          _build/sig_export _build/

      - name: Verify signature output
        run: |
          echo "Generated signature files:"
          ls -la _build/*.sig.hpp
          echo ""
          echo "Contents:"
          for f in _build/*.sig.hpp; do
            echo "=== $(basename $f) ==="
            head -30 "$f"
            echo "..."
            echo ""
          done

      - name: Upload signature artifact
        uses: actions/upload-artifact@v4
        with:
          name: sig-${{ matrix.platform }}
          path: _build/*.sig.hpp
          retention-days: 7

  # =====================================================================
  # Phase 2: Compare all signatures (C++17, no P2996 needed)
  # =====================================================================
  compare-signatures:
    needs: export-signatures
    runs-on: ubuntu-latest

    steps:
      - name: Checkout user repository
        uses: actions/checkout@v4

      - name: Checkout TypeLayout
        uses: actions/checkout@v4
        with:
          repository: aspect-labs/typelayout
          ref: ${{ inputs.typelayout_ref }}
          path: _typelayout

      - name: Download all signature artifacts
        uses: actions/download-artifact@v4
        with:
          path: _sigs
          pattern: sig-*
          merge-multiple: true

      - name: List downloaded signatures
        run: |
          echo "Downloaded signatures:"
          ls -la _sigs/
          echo ""
          for f in _sigs/*.sig.hpp; do
            echo "=== $(basename $f) ==="
            head -25 "$f"
            echo "..."
            echo ""
          done

      - name: Compile and run Phase 2
        run: |
          CHECK_SRC="${{ inputs.check_source }}"

          # Build local include flags
          INCLUDE_FLAGS=""
          if [ -n "${{ inputs.include_dirs }}" ]; then
            IFS=',' read -ra DIRS <<< "${{ inputs.include_dirs }}"
            for dir in "${DIRS[@]}"; do
              dir=$(echo "$dir" | xargs)
              [ -n "$dir" ] && INCLUDE_FLAGS+=" -I $dir"
            done
          fi

          mkdir -p _build

          g++ -std=c++17 \
            -I _typelayout/include \
            -I _sigs \
            -I . \
            $INCLUDE_FLAGS \
            -o _build/compat_check \
            "$CHECK_SRC"

          echo ""
          echo "Running compatibility report..."
          echo ""
          _build/compat_check | tee _build/report.txt

      - name: Check results
        run: |
          REPORT="_build/report.txt"

          # Extract summary line
          if grep -q "ALL.*serialization-free" "$REPORT"; then
            echo "✅ All types are compatible across all platforms!"
          else
            INCOMPATIBLE=$(grep -oP '\d+(?= type\(s\) need serialization)' "$REPORT" || echo "0")
            if [ "$INCOMPATIBLE" -gt 0 ]; then
              echo "⚠️  $INCOMPATIBLE type(s) have different layouts across platforms."
              echo "   This is an informational warning — review the report for details."
              echo ""
              echo "Types with layout differences:"
              grep '\[DIFFER\]' "$REPORT" || true
            fi
          fi

      - name: Upload compatibility report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compatibility-report
          path: |
            _build/report.txt
            _sigs/*.sig.hpp
          retention-days: 30