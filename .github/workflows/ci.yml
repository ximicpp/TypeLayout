# Continuous Integration Workflow for Boost.TypeLayout
#
# Builds and tests the library using the P2996-enabled Clang container.
#
# Copyright (c) 2024-2026 TypeLayout Development Team
# Distributed under the Boost Software License, Version 1.0.

name: CI

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths-ignore:
      - '**.md'
      - 'doc/**'
      - '.github/docker/**'

  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'doc/**'

  # Allow manual trigger
  workflow_dispatch:

  # Triggered when Docker image is built
  workflow_run:
    workflows: ["Build Docker Image"]
    types:
      - completed

env:
  REGISTRY: ghcr.io
  P2996_IMAGE: ${{ github.repository_owner }}/typelayout-p2996:latest
  # P2996 toolchain's libc++ is in non-standard path, required for test execution
  LD_LIBRARY_PATH: /opt/p2996-toolchain/lib/x86_64-unknown-linux-gnu

jobs:
  #==========================================================================
  # Check if Docker image exists
  #==========================================================================
  check-image:
    name: Check Docker Image
    runs-on: ubuntu-latest
    outputs:
      image_exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Check if P2996 image exists
        id: check
        run: |
          # Try to pull the image manifest (no download, just check)
          if docker manifest inspect ghcr.io/${{ github.repository_owner }}/typelayout-p2996:latest > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "✅ Docker image exists!"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Docker image not found. Container-based jobs will be skipped."
            echo "Please run the 'Build Docker Image' workflow first."
          fi

  #==========================================================================
  # Build and Test Matrix
  #==========================================================================
  # Currently only Bloomberg Clang supports P2996.
  # When GCC/MSVC add P2996 support, this will expand to a full matrix:
  #
  # strategy:
  #   matrix:
  #     include:
  #       - { name: "Bloomberg Clang", compiler: clang++, container: p2996 }
  #       - { name: "GCC 14", compiler: g++-14, container: gcc14 }
  #       - { name: "MSVC 19.40", os: windows-latest }
  #
  # For now, we test with Bloomberg Clang P2996 only.
  #==========================================================================
  build-and-test:
    name: Build & Test (Bloomberg Clang P2996)
    runs-on: ubuntu-latest
    needs: check-image
    if: needs.check-image.outputs.image_exists == 'true'
    container:
      image: ghcr.io/${{ github.repository_owner }}/typelayout-p2996:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Compiler
        run: |
          echo "=== Compiler Version ==="
          clang++ --version
          echo ""
          echo "=== CMake Version ==="
          cmake --version

      - name: Configure with CMake
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_CXX_FLAGS="-std=c++26 -freflection -freflection-latest -stdlib=libc++" \
            -DBUILD_TESTING=ON

      - name: Build
        run: cmake --build build --parallel

      - name: Run Compile-Time Tests
        run: |
          cmake --build build --target test_all_types
          echo "Compile-time tests passed!"

      - name: Run Unit Tests
        run: |
          cd build
          ctest --output-on-failure --parallel 4

      - name: Test Summary
        if: always()
        run: |
          echo "=== Test Results ==="
          cd build
          ctest --show-only=json-v1 | head -50 || true

  #==========================================================================
  # Static Analysis
  #==========================================================================
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    needs: check-image
    if: needs.check-image.outputs.image_exists == 'true'
    container:
      image: ghcr.io/${{ github.repository_owner }}/typelayout-p2996:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run clang-tidy
        run: |
          # Create compilation database
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_CXX_FLAGS="-std=c++26 -freflection -freflection-latest -stdlib=libc++" \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

          # Run clang-tidy on public headers
          find include -name "*.hpp" | head -10 | while read file; do
            echo "Checking $file..."
            clang-tidy "$file" \
              -p build \
              --checks='-*,bugprone-*,modernize-*,performance-*,readability-*' \
              --warnings-as-errors='' \
              || true
          done

  #==========================================================================
  # Documentation Build Check
  #==========================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (for Antora)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Antora
        run: npm install -g @antora/cli @antora/site-generator

      - name: Build Documentation
        run: |
          if [ -f "antora-playbook.yml" ]; then
            antora antora-playbook.yml
            echo "Documentation built successfully!"
          else
            echo "No antora-playbook.yml found, skipping docs build"
          fi

  #==========================================================================
  # Header-Only Verification
  #==========================================================================
  header-only-check:
    name: Header-Only Check
    runs-on: ubuntu-latest
    needs: check-image
    if: needs.check-image.outputs.image_exists == 'true'
    container:
      image: ghcr.io/${{ github.repository_owner }}/typelayout-p2996:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Single Header Inclusion
        run: |
          echo '#include <boost/typelayout.hpp>' > /tmp/test_include.cpp
          echo 'int main() { return 0; }' >> /tmp/test_include.cpp
          clang++ -std=c++26 -freflection -freflection-latest -stdlib=libc++ \
            -I./include \
            -c /tmp/test_include.cpp -o /tmp/test_include.o
          echo "Single header inclusion works!"

      - name: Check for ODR Violations
        run: |
          # Create two translation units including the same header
          echo '#include <boost/typelayout.hpp>' > /tmp/tu1.cpp
          echo 'void foo() { auto s = boost::typelayout::get_layout_signature<int>(); }' >> /tmp/tu1.cpp
          
          echo '#include <boost/typelayout.hpp>' > /tmp/tu2.cpp
          echo 'void bar() { auto s = boost::typelayout::get_layout_signature<int>(); }' >> /tmp/tu2.cpp
          echo 'int main() { return 0; }' >> /tmp/tu2.cpp
          
          clang++ -std=c++26 -freflection -freflection-latest -stdlib=libc++ -I./include \
            /tmp/tu1.cpp /tmp/tu2.cpp -o /tmp/odr_test
          echo "No ODR violations detected!"

  #==========================================================================
  # Summary (always runs)
  #==========================================================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [check-image, docs]
    if: always()
    steps:
      - name: Report Status
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.check-image.outputs.image_exists }}" == "true" ]; then
            echo "✅ **Docker Image**: Available" >> $GITHUB_STEP_SUMMARY
            echo "- Build & Test: Will run" >> $GITHUB_STEP_SUMMARY
            echo "- Static Analysis: Will run" >> $GITHUB_STEP_SUMMARY
            echo "- Header-Only Check: Will run" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Docker Image**: Not found" >> $GITHUB_STEP_SUMMARY
            echo "- Container-based jobs skipped" >> $GITHUB_STEP_SUMMARY
            echo "- Please run 'Build Docker Image' workflow first" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Documentation**: Checked" >> $GITHUB_STEP_SUMMARY