# Change: Add Cross-Platform Compatibility Checker (Pure C++)

## Why

当前的跨平台兼容性判断依赖 Python 脚本 (`compare_signatures.py`) 对比多平台 JSON 输出，
存在以下问题：
1. **引入外部依赖**：需要 Python 运行时，偏离了 C++ header-only 的库定位
2. **运行时比较**：无法利用 TypeLayout 的编译时优势，不能在编译期 `static_assert` 失败
3. **手动流程**：用户需要手动在每个平台运行、收集 JSON、再调用 Python 脚本

用户需要一个**纯 C++ 方案**，在编译工具链中完成签名的导出和比对，
实现"给定一组目标平台，编译时判断类型是否在这些平台上二进制兼容"。

## What Changes

### 新增 capability: `cross-platform-compat`

**两阶段编译时管线**：

```
Phase 1: Export (per-platform)              Phase 2: Check (any platform)
┌─────────────────────────┐                ┌──────────────────────────────┐
│ x86_64-linux-clang      │                │ #include all .sig.hpp        │
│ compile + run sig_export │──► .sig.hpp ──►│                              │
└─────────────────────────┘                │ static_assert(               │
┌─────────────────────────┐                │   sig_match(plat_a, plat_b)  │
│ arm64-linux-clang       │                │ );                           │
│ compile + run sig_export │──► .sig.hpp ──►│                              │
└─────────────────────────┘                │ // 编译成功 = 所有类型兼容    │
┌─────────────────────────┐                │ // 编译失败 = 不兼容类型报错  │
│ x86_64-windows-msvc     │                │                              │
│ compile + run sig_export │──► .sig.hpp ──►│ // 可选: 运行时详细报告       │
└─────────────────────────┘                └──────────────────────────────┘
```

**核心组件**：

1. **`tools/sig_export.hpp`** — 签名导出工具
   - `SigExporter` 类：收集类型签名，生成 `.sig.hpp` 头文件
   - 自动检测平台名称（`arch_os_compiler` 格式）
   - 支持手动指定平台名称
   - 输出 `constexpr const char[]` 签名，可在其他平台编译时直接读取

2. **`tools/compat_check.hpp`** — 编译时兼容性检查
   - `constexpr sig_match(a, b)` — 比较两个签名字符串
   - `constexpr all_layout_compatible<PlatformSigs...>()` — 批量比较
   - `is_portable<T>()` — 判断类型是否只使用定宽字段
   - 运行时报告器：输出详细兼容性矩阵

3. **`tools/platform_detect.hpp`** — 平台自动检测
   - 通过预定义宏检测 arch + OS + compiler
   - 生成规范化的平台标识字符串

4. **更新 example** — 纯 C++ 工作流替代 Python 方案

5. **CMake 模块** — `cmake/TypeLayoutCompat.cmake`
   - `typelayout_add_sig_export()` — 添加签名导出目标
   - `typelayout_add_compat_check()` — 添加兼容性检查目标

### 生成的 `.sig.hpp` 格式

```cpp
// AUTO-GENERATED by Boost.TypeLayout Signature Export Tool
// Platform: x86_64_linux_clang
// Generated: 2026-02-08T11:00:00Z
#pragma once

namespace boost { namespace typelayout { namespace platform {
namespace x86_64_linux_clang {

inline constexpr const char platform_name[] = "x86_64_linux_clang";
inline constexpr const char arch_prefix[]   = "[64-le]";
inline constexpr unsigned pointer_size      = 8;
inline constexpr unsigned sizeof_long       = 8;
inline constexpr unsigned sizeof_wchar_t    = 4;
inline constexpr unsigned sizeof_long_double = 16;

// --- PacketHeader ---
inline constexpr const char PacketHeader_layout[] =
    "[64-le]record[s:16,a:4]{@0:u32[s:4,a:4],@4:u16[s:2,a:2],...}";
inline constexpr const char PacketHeader_definition[] =
    "[64-le]record[s:16,a:4]{@0[magic]:u32[s:4,a:4],...}";

// ... more types ...

}}}} // namespace boost::typelayout::platform::x86_64_linux_clang
```

### 使用示例

**Phase 1: 导出**
```cpp
// export_sigs.cpp — 在每个目标平台编译运行
#include <boost/typelayout/tools/sig_export.hpp>
#include "my_protocol.hpp"

int main() {
    using namespace boost::typelayout;
    SigExporter ex;  // 自动检测平台名
    ex.add<PacketHeader>("PacketHeader");
    ex.add<SharedMemRegion>("SharedMemRegion");
    ex.add<SensorRecord>("SensorRecord");
    return ex.write("sigs/" + ex.platform_name() + ".sig.hpp");
}
```

**Phase 2: 检查**
```cpp
// check_compat.cpp — 在任意平台编译
#include "sigs/x86_64_linux_clang.sig.hpp"
#include "sigs/arm64_linux_clang.sig.hpp"
#include <boost/typelayout/tools/compat_check.hpp>

namespace plat_a = boost::typelayout::platform::x86_64_linux_clang;
namespace plat_b = boost::typelayout::platform::arm64_linux_clang;

using boost::typelayout::compat::layout_match;

// 编译时断言 — 编译通过即证明兼容
static_assert(layout_match(plat_a::PacketHeader_layout,
                           plat_b::PacketHeader_layout),
    "PacketHeader not binary-compatible across platforms!");

// 运行时详细报告
int main() {
    boost::typelayout::compat::CompatReporter reporter;
    reporter.add_platform("x86_64_linux_clang", plat_a::types, plat_a::type_count);
    reporter.add_platform("arm64_linux_clang",  plat_b::types, plat_b::type_count);
    reporter.print_report();
}
```

## Impact

- **新增 spec**: `cross-platform-compat`
- **新增文件**:
  - `include/boost/typelayout/tools/sig_export.hpp`
  - `include/boost/typelayout/tools/compat_check.hpp`
  - `include/boost/typelayout/tools/platform_detect.hpp`
  - `cmake/TypeLayoutCompat.cmake`
  - `example/cross_platform_check.cpp` (重写)
  - `example/compat_check.cpp` (新增)
  - `test/test_compat_check.cpp`
- **删除文件**:
  - `scripts/compare_signatures.py` (用纯 C++ 替代)
- **受影响 spec**: `signature` (无修改，仅被依赖)
- **非破坏性**: 不修改核心签名引擎，只增加工具层
